<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×©××œ×•× ×™× - ×¨×•×¢×™ ×¨×•×× ×•</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
/* ===== ×¦×‘×¢×™ ×”××•×ª×’ ===== */
:root {
    --navy-primary: #1A2B3C;
    --navy-secondary: #0f1a26;
    --dark-gray: #2A3B4C;
    --gold-primary: #D4AF37;
    --gold-light: #E8C547;
    --white: #FFFFFF;
    --text-gray: #374151;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: 2rem 1rem;
    direction: rtl;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

.header {
    background: linear-gradient(135deg, var(--navy-primary) 0%, var(--navy-secondary) 100%);
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    border: 2px solid var(--gold-primary);
}

.header h1 {
    color: var(--white);
    font-size: 2rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header p {
    color: var(--gold-light);
    font-size: 1rem;
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--white);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 2px solid var(--gold-primary);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--navy-primary), var(--dark-gray));
    color: var(--gold-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-content h3 {
    color: var(--text-gray);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.stat-content p {
    color: var(--navy-primary);
    font-size: 1.8rem;
    font-weight: 700;
}

.controls {
    background: var(--white);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 2px solid var(--gold-primary);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 2px solid var(--gold-primary);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.search-box input:focus {
    outline: none;
    border-color: var(--gold-light);
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
}

.search-box i {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold-primary);
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(45deg, var(--gold-primary), var(--gold-light));
    color: var(--navy-primary);
}

.btn-primary:hover {
    background: linear-gradient(45deg, var(--gold-light), var(--gold-primary));
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
}

.btn-secondary {
    background: var(--white);
    color: var(--navy-primary);
    border: 2px solid var(--gold-primary);
}

.btn-secondary:hover {
    background: var(--gold-light);
    transform: translateY(-2px);
}

.responses-table {
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    border: 2px solid var(--gold-primary);
    overflow: hidden;
}

.table-wrapper {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background: linear-gradient(135deg, var(--navy-primary) 0%, var(--navy-secondary) 100%);
}

thead th {
    color: var(--white);
    padding: 1rem;
    text-align: right;
    font-weight: 600;
    white-space: nowrap;
}

tbody tr {
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    transition: background 0.3s ease;
    cursor: pointer;
}

tbody tr:hover {
    background: rgba(212, 175, 55, 0.05);
}

tbody td {
    padding: 1rem;
    color: var(--text-gray);
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-new {
    background: #10b981;
    color: white;
}

.status-viewed {
    background: #6b7280;
    color: white;
}

.risk-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.risk-low {
    background: #10b981;
    color: white;
}

.risk-medium {
    background: #f59e0b;
    color: white;
}

.risk-high {
    background: #ef4444;
    color: white;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 1rem;
    overflow-y: auto;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--white);
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    border: 2px solid var(--gold-primary);
    position: relative;
}

.modal-header {
    background: linear-gradient(135deg, var(--navy-primary) 0%, var(--navy-secondary) 100%);
    padding: 1.5rem;
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 2px solid var(--gold-primary);
}

.modal-header h2 {
    color: var(--white);
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.modal-header p {
    color: var(--gold-light);
    font-size: 0.9rem;
}

.close-modal {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: var(--white);
    font-size: 1.5rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.close-modal:hover {
    background: rgba(255, 255, 255, 0.3);
}

.modal-body {
    padding: 2rem;
}

.response-section {
    margin-bottom: 2rem;
}

.response-section h3 {
    color: var(--navy-primary);
    font-size: 1.2rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--gold-primary);
}

.response-item {
    margin-bottom: 1rem;
    padding: 1rem;
    background: rgba(212, 175, 55, 0.05);
    border-right: 4px solid var(--gold-primary);
    border-radius: 4px;
}

.response-item strong {
    display: block;
    color: var(--navy-primary);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.response-item span {
    color: var(--text-gray);
    font-size: 1rem;
}

.loading {
    text-align: center;
    padding: 3rem;
    color: var(--text-gray);
}

.loading i {
    font-size: 3rem;
    color: var(--gold-primary);
    margin-bottom: 1rem;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-gray);
}

.empty-state i {
    font-size: 4rem;
    color: var(--gold-primary);
    margin-bottom: 1rem;
}

.empty-state h3 {
    color: var(--navy-primary);
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    padding: 1.5rem;
    background: var(--white);
    border-radius: 12px;
    margin-top: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 2px solid var(--gold-primary);
}

.pagination button {
    padding: 0.5rem 1rem;
    border: 2px solid var(--gold-primary);
    background: var(--white);
    color: var(--navy-primary);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.pagination button:hover:not(:disabled) {
    background: var(--gold-light);
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination span {
    color: var(--navy-primary);
    font-weight: 600;
    margin: 0 1rem;
}

@media (max-width: 768px) {
    body {
        padding: 1rem 0.5rem;
    }
    
    .header h1 {
        font-size: 1.5rem;
    }
    
    .stats-container {
        grid-template-columns: 1fr;
    }
    
    .controls {
        flex-direction: column;
    }
    
    .search-box {
        width: 100%;
    }
    
    .table-wrapper {
        overflow-x: auto;
    }
    
    table {
        font-size: 0.85rem;
    }
    
    thead th,
    tbody td {
        padding: 0.75rem 0.5rem;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <button onclick="logout()" style="position: absolute; top: 1rem; left: 1rem; padding: 0.5rem 1rem; border: 2px solid var(--gold-primary); background: rgba(255,255,255,0.1); color: var(--white); border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; font-weight: 600;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <i class="fas fa-sign-out-alt"></i> ×”×ª× ×ª×§
            </button>
            <h1>
                <i class="fas fa-chart-line"></i>
                ×œ×•×— × ×™×”×•×œ ×©××œ×•× ×™×
            </h1>
            <p>×¨×•×¢×™ ×¨×•×× ×• - ××ª×›× ×Ÿ ×¤×™× × ×¡×™ | ×¦×¤×™×™×” ×•× ×™×”×•×œ ×›×œ ×ª×©×•×‘×•×ª ×”×œ×§×•×—×•×ª</p>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-content">
                    <h3>×¡×š ×”×›×œ ×©××œ×•× ×™×</h3>
                    <p id="totalCount">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-content">
                    <h3>×©××œ×•× ×™× ×”×™×•×</h3>
                    <p id="todayCount">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="stat-content">
                    <h3>×××•×¦×¢ ×¨××ª ×¡×™×›×•×Ÿ</h3>
                    <p id="avgRisk">0</p>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="×—×¤×© ×œ×¤×™ ×©×, ××™×™×œ ××• ×˜×œ×¤×•×Ÿ...">
            </div>
            <button class="btn btn-primary" onclick="loadResponses()">
                <i class="fas fa-sync-alt"></i> ×¨×¢× ×Ÿ
            </button>
            <button class="btn btn-secondary" onclick="exportToCSV()">
                <i class="fas fa-download"></i> ×™×™×¦×•× Excel
            </button>
        </div>

        <div class="responses-table">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š</th>
                            <th>×©× ××œ×</th>
                            <th>××™×™×œ</th>
                            <th>×˜×œ×¤×•×Ÿ</th>
                            <th>×¨××ª ×¡×™×›×•×Ÿ</th>
                            <th>××¦×‘ ×ª×¢×¡×•×§×ª×™</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="responsesTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevPage" onclick="changePage(-1)">
                <i class="fas fa-chevron-right"></i> ×”×§×•×“×
            </button>
            <span id="pageInfo">×¢××•×“ 1 ××ª×•×š 1</span>
            <button id="nextPage" onclick="changePage(1)">
                ×”×‘× <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </div>

    <!-- Modal for viewing full response -->
    <div class="modal" id="responseModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
                <h2 id="modalTitle">×¤×¨×˜×™ ×©××œ×•×Ÿ</h2>
                <p id="modalSubtitle"></p>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
// ===== PASSWORD PROTECTION =====
// ×©× ×” ××ª ×”×¡×™×¡××” ×›××Ÿ ×œ×¤× ×™ ×¤×¨×¡×•×!
const ADMIN_PASSWORD = "Roei2024!";

// Check password on page load
(function() {
    const isAuthenticated = sessionStorage.getItem('adminAuthenticated');
    
    if (isAuthenticated !== 'true') {
        let attempts = 0;
        const maxAttempts = 3;
        
        while (attempts < maxAttempts) {
            const password = prompt(`ğŸ” ×”×–×Ÿ ×¡×™×¡××ª ×× ×”×œ:\n\n(× ×™×¡×™×•×Ÿ ${attempts + 1} ××ª×•×š ${maxAttempts})`);
            
            if (password === null) {
                // User cancelled
                alert('âš ï¸ ×’×™×©×” × ×“×—×ª×”');
                window.location.href = 'index.html';
                return;
            }
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                break;
            } else {
                attempts++;
                if (attempts >= maxAttempts) {
                    alert('âŒ ×¡×™×¡××” ×©×’×•×™×” 3 ×¤×¢××™×. ×’×™×©×” × ×—×¡××”.');
                    window.location.href = 'index.html';
                    return;
                } else {
                    alert(`âŒ ×¡×™×¡××” ×©×’×•×™×”. × ×•×ª×¨×• ${maxAttempts - attempts} × ×™×¡×™×•× ×•×ª`);
                }
            }
        }
    }
})();

// Add logout functionality
function logout() {
    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
        sessionStorage.removeItem('adminAuthenticated');
        window.location.href = 'index.html';
    }
}

// Clear authentication on browser close (security)
window.addEventListener('beforeunload', () => {
    // Optional: uncomment to force re-login on browser close
    // sessionStorage.removeItem('adminAuthenticated');
});

let allResponses = [];
let filteredResponses = [];
let currentPage = 1;
const itemsPerPage = 10;

// Load responses on page load
document.addEventListener('DOMContentLoaded', () => {
    loadResponses();
    
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        filteredResponses = allResponses.filter(response => {
            return (
                (response.fullName || '').toLowerCase().includes(searchTerm) ||
                (response.email || '').toLowerCase().includes(searchTerm) ||
                (response.phoneNumber || '').toLowerCase().includes(searchTerm)
            );
        });
        currentPage = 1;
        renderTable();
    });
});

async function loadResponses() {
    try {
        const response = await fetch('tables/questionnaire_responses?limit=1000&sort=-created_at');
        
        if (!response.ok) {
            throw new Error('Failed to load responses');
        }
        
        const data = await response.json();
        allResponses = data.data || [];
        filteredResponses = allResponses;
        
        updateStats();
        renderTable();
        
    } catch (error) {
        console.error('Error loading responses:', error);
        document.getElementById('responsesTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3>
                    <p>×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨</p>
                </td>
            </tr>
        `;
    }
}

function updateStats() {
    // Total count
    document.getElementById('totalCount').textContent = allResponses.length;
    
    // Today count
    const today = new Date().toDateString();
    const todayCount = allResponses.filter(r => {
        const responseDate = new Date(r.created_at).toDateString();
        return responseDate === today;
    }).length;
    document.getElementById('todayCount').textContent = todayCount;
    
    // Average risk
    const riskScores = allResponses
        .map(r => r.risk_average)
        .filter(r => r !== null && r !== undefined);
    
    if (riskScores.length > 0) {
        const avgRisk = (riskScores.reduce((a, b) => Number(a) + Number(b), 0) / riskScores.length).toFixed(1);
        document.getElementById('avgRisk').textContent = avgRisk;
    } else {
        document.getElementById('avgRisk').textContent = 'N/A';
    }
}

function renderTable() {
    const tbody = document.getElementById('responsesTableBody');
    
    if (filteredResponses.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>××™×Ÿ ×©××œ×•× ×™× ×œ××¢×§×‘</h3>
                    <p>×›××©×¨ ×œ×§×•×—×•×ª ×™×©×œ×—×• ×©××œ×•× ×™×, ×”× ×™×•×¤×™×¢×• ×›××Ÿ</p>
                </td>
            </tr>
        `;
        document.getElementById('pagination').style.display = 'none';
        return;
    }
    
    // Pagination
    const totalPages = Math.ceil(filteredResponses.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageResponses = filteredResponses.slice(startIndex, endIndex);
    
    // Render rows
    tbody.innerHTML = pageResponses.map(response => {
        const date = new Date(response.created_at).toLocaleDateString('he-IL', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const riskBadge = getRiskBadge(response.risk_average);
        const employmentStatus = Array.isArray(response.employmentStatus) 
            ? response.employmentStatus.join(', ') 
            : (response.employmentStatus || '×œ× ×¦×•×™×Ÿ');
        
        return `
            <tr onclick="viewResponse('${response.id}')">
                <td>${date}</td>
                <td><strong>${response.fullName || '×œ× ×¦×•×™×Ÿ'}</strong></td>
                <td>${response.email || '×œ× ×¦×•×™×Ÿ'}</td>
                <td>${response.phoneNumber || '×œ× ×¦×•×™×Ÿ'}</td>
                <td>${riskBadge}</td>
                <td>${employmentStatus}</td>
                <td>
                    <button class="btn btn-primary" onclick="event.stopPropagation(); viewResponse('${response.id}')" style="padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                        <i class="fas fa-eye"></i> ×¦×¤×™×™×”
                    </button>
                    <button class="btn" onclick="event.stopPropagation(); deleteResponse('${response.id}', '${response.fullName || '×œ×§×•×—'}')" style="padding: 0.5rem 0.75rem; font-size: 0.85rem; background: #ef4444; color: white; margin-right: 0.5rem;">
                        <i class="fas fa-trash"></i> ××—×§
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Update pagination
    document.getElementById('pagination').style.display = totalPages > 1 ? 'flex' : 'none';
    document.getElementById('pageInfo').textContent = `×¢××•×“ ${currentPage} ××ª×•×š ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
}

function getRiskBadge(riskAverage) {
    if (!riskAverage) return '<span class="risk-badge" style="background: #6b7280;">×œ× ×¦×•×™×Ÿ</span>';
    
    const risk = Number(riskAverage);
    if (risk <= 3) {
        return `<span class="risk-badge risk-low">${risk} - × ××•×›×”</span>`;
    } else if (risk <= 6) {
        return `<span class="risk-badge risk-medium">${risk} - ×‘×™× ×•× ×™×ª</span>`;
    } else {
        return `<span class="risk-badge risk-high">${risk} - ×’×‘×•×”×”</span>`;
    }
}

function changePage(direction) {
    currentPage += direction;
    renderTable();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function viewResponse(responseId) {
    const response = allResponses.find(r => r.id === responseId);
    if (!response) return;
    
    // Set modal title
    document.getElementById('modalTitle').textContent = `×©××œ×•×Ÿ: ${response.fullName || '×œ×§×•×—'}`;
    const date = new Date(response.created_at).toLocaleDateString('he-IL', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    document.getElementById('modalSubtitle').textContent = `× ×©×œ×— ×‘×ª××¨×™×š: ${date}`;
    
    // Build modal content
    let modalContent = '';
    
    // Section 1: ×¤×¨×˜×™× ××™×©×™×™×
    modalContent += '<div class="response-section">';
    modalContent += '<h3><i class="fas fa-user"></i> ×¤×¨×˜×™× ××™×©×™×™×</h3>';
    modalContent += buildResponseItem('×©× ××œ×', response.fullName);
    modalContent += buildResponseItem('×›×ª×•×‘×ª ××™×™×œ', response.email);
    modalContent += buildResponseItem('××¡×¤×¨ ×˜×œ×¤×•×Ÿ', response.phoneNumber);
    modalContent += buildResponseItem('××¡×¤×¨ ×–×”×•×ª', response.idNumber);
    modalContent += buildResponseItem('×ª××¨×™×š ×œ×™×“×”', response.birthDate);
    modalContent += buildResponseItem('×›×ª×•×‘×ª ××’×•×¨×™×', response.address);
    modalContent += buildResponseItem('××¦×‘ ××©×¤×—×ª×™', response.maritalStatus);
    modalContent += buildResponseItem('×™×œ×“×™×', response.hasChildren);
    if (response.childrenAges) {
        modalContent += buildResponseItem('×’×™×œ××™ ×”×™×œ×“×™×', response.childrenAges);
    }
    modalContent += '</div>';
    
    // Section 2: ×¨××ª ×¡×™×›×•×Ÿ
    if (response.risk1 || response.risk2 || response.risk3) {
        modalContent += '<div class="response-section">';
        modalContent += '<h3><i class="fas fa-chart-line"></i> ×©××œ×•×Ÿ ×¨××ª ×¡×™×›×•×Ÿ</h3>';
        modalContent += buildResponseItem('×©××œ×” 1', response.risk1);
        modalContent += buildResponseItem('×©××œ×” 2', response.risk2);
        modalContent += buildResponseItem('×©××œ×” 3', response.risk3);
        modalContent += buildResponseItem('×©××œ×” 4', response.risk4);
        modalContent += buildResponseItem('×©××œ×” 5', response.risk5);
        modalContent += buildResponseItem('×©××œ×” 6', response.risk6);
        modalContent += buildResponseItem('×××•×¦×¢ ×¨××ª ×¡×™×›×•×Ÿ', response.risk_average, true);
        modalContent += '</div>';
    }
    
    // Section 3: ××¦×‘ ×ª×¢×¡×•×§×ª×™ ×•×¢×™×¡×•×§
    modalContent += '<div class="response-section">';
    modalContent += '<h3><i class="fas fa-briefcase"></i> ××¦×‘ ×ª×¢×¡×•×§×ª×™ ×•×¢×™×¡×•×§</h3>';
    modalContent += buildResponseItem('××¦×‘ ×ª×¢×¡×•×§×ª×™', 
        Array.isArray(response.employmentStatus) ? response.employmentStatus.join(', ') : response.employmentStatus);
    
    if (response.employerName) {
        modalContent += buildResponseItem('×©× ×”××¢×¡×™×§', response.employerName);
    }
    if (response.currentOccupationEmployee) {
        modalContent += buildResponseItem('×¢×™×¡×•×§/×ª×¤×§×™×“ × ×•×›×—×™', response.currentOccupationEmployee);
    }
    if (response.businessName) {
        modalContent += buildResponseItem('×©× ×”×¢×¡×§', response.businessName);
        modalContent += buildResponseItem('×›×ª×•×‘×ª ×”×¢×¡×§', response.businessAddress);
        modalContent += buildResponseItem('××—×–×•×¨ ×”×›× ×¡×•×ª ×©× ×ª×™', response.annualRevenue);
        modalContent += buildResponseItem('×ª×—×•× ×¢×™×¡×•×§', response.businessField);
    }
    modalContent += '</div>';
    
    // Section 4: ×”×©×§×¢×•×ª ×•×—×™×¡×›×•×Ÿ
    modalContent += '<div class="response-section">';
    modalContent += '<h3><i class="fas fa-piggy-bank"></i> ×”×©×§×¢×•×ª ×•×—×™×¡×›×•×Ÿ</h3>';
    modalContent += buildResponseItem('××§×•×¨ ×”×›×¡×¤×™×', 
        Array.isArray(response.fundsSource) ? response.fundsSource.join(', ') : response.fundsSource);
    modalContent += buildResponseItem('×¡×›×•× ×”×¤×§×“×” ×©× ×ª×™', response.annualDeposits);
    modalContent += buildResponseItem('×ª×“×™×¨×•×ª ×”×¤×§×“×•×ª', response.depositFrequency);
    modalContent += buildResponseItem('×˜×•×•×— ×”×©×§×¢×”', response.investmentHorizon);
    modalContent += buildResponseItem('××˜×¨×ª ×”×—×™×¡×›×•×Ÿ', 
        Array.isArray(response.savingsGoals) ? response.savingsGoals.join(', ') : response.savingsGoals);
    modalContent += buildResponseItem('××¦×‘ ×›×¡×¤×™', response.financialStatus);
    if (response.moneyManagement) {
        modalContent += buildResponseItem('× ×™×”×•×œ ×›×¡×£ × ×›×•×Ÿ', response.moneyManagement);
    }
    modalContent += '</div>';
    
    // Section 5: ××™×“×¢ × ×•×¡×£
    modalContent += '<div class="response-section">';
    modalContent += '<h3><i class="fas fa-info-circle"></i> ××™×“×¢ × ×•×¡×£</h3>';
    modalContent += buildResponseItem('××–×¨×—×•×ª/×ª×•×©×‘×•×ª ××¨×”"×‘', response.usCitizen);
    modalContent += buildResponseItem('×ª×•×©×‘ ××¡ ×‘××“×™× ×” ××—×¨×ª', response.otherTaxResident);
    if (response.taxCountry) {
        modalContent += buildResponseItem('××“×™× ×” ×œ×¦×¨×›×™ ××¡', response.taxCountry);
        modalContent += buildResponseItem('××¡×¤×¨ TIN', response.tin);
    }
    if (response.taxRefundCheck) {
        modalContent += buildResponseItem('×‘×“×™×§×ª ×”×—×–×¨×™ ××¡', response.taxRefundCheck);
    }
    modalContent += buildResponseItem('××˜×¨×ª ×”×œ×™×•×•×™ ×”×¤×™× × ×¡×™', 
        Array.isArray(response.consultingGoals) ? response.consultingGoals.join(', ') : response.consultingGoals);
    modalContent += '</div>';
    
    // Add delete button at bottom
    modalContent += `
        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(212, 175, 55, 0.3);">
            <button onclick="deleteResponse('${response.id}', '${response.fullName || '×œ×§×•×—'}')" style="padding: 0.75rem 2rem; border: none; border-radius: 8px; background: #ef4444; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-trash"></i> ××—×§ ×©××œ×•×Ÿ ×–×”
            </button>
            <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                <i class="fas fa-exclamation-triangle"></i> ×¤×¢×•×œ×ª ××—×™×§×” ××™× ×” ×”×¤×™×›×”
            </p>
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = modalContent;
    document.getElementById('responseModal').classList.add('active');
}

function buildResponseItem(label, value, highlight = false) {
    if (!value && value !== 0) return '';
    
    const style = highlight ? 'background: rgba(212, 175, 55, 0.15); border-right: 4px solid var(--gold-light);' : '';
    return `
        <div class="response-item" style="${style}">
            <strong>${label}:</strong>
            <span>${value}</span>
        </div>
    `;
}

function closeModal() {
    document.getElementById('responseModal').classList.remove('active');
}

async function deleteResponse(responseId, clientName) {
    // Confirmation dialog
    const confirmed = confirm(`âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×©××œ×•×Ÿ ×©×œ:\n\n${clientName}\n\n×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”!`);
    
    if (!confirmed) {
        return;
    }
    
    // Second confirmation for safety
    const doubleConfirm = confirm(`ğŸ”´ ××™×©×•×¨ ×¡×•×¤×™:\n\n××—×™×§×ª ×”× ×ª×•× ×™× ×©×œ ${clientName} ×ª×”×™×” ×§×‘×•×¢×”.\n\n×”×× ×œ×”××©×™×š?`);
    
    if (!doubleConfirm) {
        return;
    }
    
    try {
        // Show loading state
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 9999; text-align: center;';
        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gold-primary);"></i><p style="margin-top: 1rem;">××•×—×§...</p>';
        document.body.appendChild(loadingDiv);
        
        // Delete from API
        const response = await fetch(`tables/questionnaire_responses/${responseId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('×©×’×™××” ×‘××—×™×§×ª ×”× ×ª×•× ×™×');
        }
        
        // Remove loading
        document.body.removeChild(loadingDiv);
        
        // Show success message
        alert(`âœ… ×”×©××œ×•×Ÿ ×©×œ ${clientName} × ××—×§ ×‘×”×¦×œ×—×”`);
        
        // Close modal if open
        closeModal();
        
        // Reload data
        await loadResponses();
        
    } catch (error) {
        console.error('Error deleting response:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×©××œ×•×Ÿ. ×× × × ×¡×” ×©×•×‘.');
    }
}

async function deleteResponse(responseId, clientName) {
    // Confirm deletion
    const confirmed = confirm(`âŒ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×©××œ×•×Ÿ ×©×œ:\n\n"${clientName}"\n\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`);
    
    if (!confirmed) return;
    
    // Double confirmation for safety
    const doubleConfirm = confirm(`âš ï¸ ××™×©×•×¨ ×¡×•×¤×™!\n\n×”× ×ª×•× ×™× ×©×œ "${clientName}" ×™×™××—×§×• ×œ×¦××™×ª×•×ª.\n×”××©×š?`);
    
    if (!doubleConfirm) return;
    
    try {
        // Show loading
        const loadingModal = document.createElement('div');
        loadingModal.className = 'modal active';
        loadingModal.innerHTML = `
            <div class="modal-content">
                <h2>××•×—×§ × ×ª×•× ×™×...</h2>
                <p>×× × ×”××ª×Ÿ</p>
                <div style="text-align: center; margin-top: 1rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gold-primary);"></i>
                </div>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        // Delete from API
        const response = await fetch(`tables/questionnaire_responses/${responseId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('×©×’×™××” ×‘××—×™×§×ª ×”× ×ª×•× ×™×');
        }
        
        // Remove loading modal
        document.body.removeChild(loadingModal);
        
        // Show success message
        const successModal = document.createElement('div');
        successModal.className = 'modal active';
        successModal.innerHTML = `
            <div class="modal-content">
                <h2 style="color: #10b981;"><i class="fas fa-check-circle"></i> × ××—×§ ×‘×”×¦×œ×—×”</h2>
                <p>×”×©××œ×•×Ÿ ×©×œ <strong>${clientName}</strong> × ××—×§ ××”××¢×¨×›×ª</p>
                <button onclick="this.closest('.modal').remove(); loadResponses();" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    ×¡×’×•×¨
                </button>
            </div>
        `;
        document.body.appendChild(successModal);
        
    } catch (error) {
        console.error('Error deleting response:', error);
        
        // Show error message
        alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”× ×ª×•× ×™×. ×× × × ×¡×” ×©×•×‘.');
    }
}

function exportToCSV() {
    if (filteredResponses.length === 0) {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
        return;
    }
    
    // CSV Headers
    const headers = [
        '×ª××¨×™×š',
        '×©× ××œ×',
        '××™×™×œ',
        '×˜×œ×¤×•×Ÿ',
        '×ª.×–.',
        '×ª××¨×™×š ×œ×™×“×”',
        '×›×ª×•×‘×ª',
        '××¦×‘ ××©×¤×—×ª×™',
        '×™×œ×“×™×',
        '×’×™×œ××™ ×™×œ×“×™×',
        '××¦×‘ ×ª×¢×¡×•×§×ª×™',
        '×©× ××¢×¡×™×§',
        '×ª×¤×§×™×“',
        '×©× ×¢×¡×§',
        '×›×ª×•×‘×ª ×¢×¡×§',
        '××—×–×•×¨ ×©× ×ª×™',
        '×ª×—×•× ×¢×™×¡×•×§',
        '××§×•×¨ ×›×¡×¤×™×',
        '×”×¤×§×“×” ×©× ×ª×™×ª',
        '×ª×“×™×¨×•×ª ×”×¤×§×“×•×ª',
        '×˜×•×•×— ×”×©×§×¢×”',
        '××˜×¨×ª ×—×™×¡×›×•×Ÿ',
        '××¦×‘ ×›×¡×¤×™',
        '× ×™×”×•×œ × ×›×•×Ÿ',
        '×‘×“×™×§×ª ×”×—×–×¨×™ ××¡',
        '××˜×¨×ª ×œ×™×•×•×™',
        '××–×¨×—×•×ª ××¨×”"×‘',
        '×ª×•×©×‘ ××¡ ××—×¨',
        '××“×™× ×ª ××¡',
        'TIN',
        '×¨××ª ×¡×™×›×•×Ÿ ×××•×¦×¢',
        '×¡×™×›×•×Ÿ 1',
        '×¡×™×›×•×Ÿ 2',
        '×¡×™×›×•×Ÿ 3',
        '×¡×™×›×•×Ÿ 4',
        '×¡×™×›×•×Ÿ 5',
        '×¡×™×›×•×Ÿ 6'
    ];
    
    // CSV Rows
    const rows = filteredResponses.map(r => {
        const date = new Date(r.created_at).toLocaleDateString('he-IL');
        return [
            date,
            r.fullName || '',
            r.email || '',
            r.phoneNumber || '',
            r.idNumber || '',
            r.birthDate || '',
            r.address || '',
            r.maritalStatus || '',
            r.hasChildren || '',
            r.childrenAges || '',
            Array.isArray(r.employmentStatus) ? r.employmentStatus.join('; ') : (r.employmentStatus || ''),
            r.employerName || '',
            r.currentOccupationEmployee || '',
            r.businessName || '',
            r.businessAddress || '',
            r.annualRevenue || '',
            r.businessField || '',
            Array.isArray(r.fundsSource) ? r.fundsSource.join('; ') : (r.fundsSource || ''),
            r.annualDeposits || '',
            r.depositFrequency || '',
            r.investmentHorizon || '',
            Array.isArray(r.savingsGoals) ? r.savingsGoals.join('; ') : (r.savingsGoals || ''),
            r.financialStatus || '',
            r.moneyManagement || '',
            r.taxRefundCheck || '',
            Array.isArray(r.consultingGoals) ? r.consultingGoals.join('; ') : (r.consultingGoals || ''),
            r.usCitizen || '',
            r.otherTaxResident || '',
            r.taxCountry || '',
            r.tin || '',
            r.risk_average || '',
            r.risk1 || '',
            r.risk2 || '',
            r.risk3 || '',
            r.risk4 || '',
            r.risk5 || '',
            r.risk6 || ''
        ].map(v => `"${String(v).replace(/"/g, '""')}"`);
    });
    
    // Build CSV with BOM for Excel Hebrew support
    const BOM = '\uFEFF';
    const csvContent = BOM + [headers, ...rows].map(row => row.join(',')).join('\n');
    
    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `questionnaires_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    </script>
</body>
</html>